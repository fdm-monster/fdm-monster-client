<template>
  <div>
    <div v-if="gridStore.gridEditMode" class="ml-4 mt-4 mb-0" style="cursor: move">
      <span class="pr-4">
        Drag and drop {{ printersStore.floorlessPrinters.length }} unplaced printer(s) here:
      </span>
      <div
        v-for="printer of printersStore.floorlessPrinters"
        :key="printer.id"
        class="d-inline-block text-center mr-1 mb-1"
        draggable="true"
        style="width: 100px; height: 40px; border: 1px solid gray; border-radius: 2px"
        @dragstart="onDragStart(printer, $event)"
      >
        <strong text-center>{{ printer.printerName }}</strong>
      </div>
      <div class="mt-4">Clear printers by clicking on their tile below:</div>
    </div>
    <v-row v-for="y of rows" :key="y" class="ma-1" no-gutters>
      <v-col v-for="x of columns" :key="x" :cols="columnWidth" :sm="columnWidth" no-gutters>
        <PrinterGridTile :printer="getPrinter(x, y)" :x="x" :y="y" />
      </v-col>
    </v-row>
  </div>
</template>

<script lang="ts">
import { defineComponent } from "vue";
import { socketIoFloors } from "../../event-bus/socketio.events";
import PrinterGridTile from "@/components/PrinterGrid/PrinterGridTile.vue";
import { gridCols, gridRows, totalVuetifyColumnCount } from "@/constants/printer-grid.constants";
import { usePrintersStore } from "@/store/printers.store";
import { Printer } from "../../models/printers/printer.model";
import { useGridStore } from "../../store/grid.store";
import { dragAppId, INTENT, PrinterPlace } from "../../constants/drag.constants";

export default defineComponent({
  components: { PrinterGridTile },
  data(): {
    maxColumnUnits: number;
    printerMatrix: (Printer | undefined)[][];
  } {
    return {
      maxColumnUnits: totalVuetifyColumnCount,
      printerMatrix: [],
    };
  },
  setup() {
    return {
      printersStore: usePrintersStore(),
      gridStore: useGridStore(),
    };
  },
  async created() {
    await this.printersStore.loadPrinters();
    await this.printersStore.loadFloors();

    this.updateGridMatrix();
  },
  computed: {
    columnWidth() {
      return totalVuetifyColumnCount / 12;
    },
    columns() {
      return [...Array(gridCols).keys()];
    },
    rows() {
      return [...Array(gridRows).keys()];
    },
    printers() {
      return this.printersStore.printers;
    },
    selectedFloorLevel() {
      return this.printersStore.selectedFloor?.floor;
    },
  },
  methods: {
    onDragStart(printer: Printer, ev: DragEvent) {
      if (!ev.dataTransfer) return;
      if (!printer.id) return;

      ev.dataTransfer.setData(
        "text",
        JSON.stringify({
          appId: dragAppId,
          intent: INTENT.PRINTER_PLACE,
          printerId: printer.id,
        } as PrinterPlace)
      );
    },
    getPrinter(col: number, row: number) {
      if (!this.printerMatrix?.length || !this.printerMatrix[col - 1]) {
        return;
      }
      return this.printerMatrix[col - 1][row - 1];
    },
    updateGridMatrix() {
      this.printerMatrix = this.printersStore.gridSortedPrinters;
    },
    onSocketIoFloorMessage() {
      this.updateGridMatrix();
    },
  },
  async mounted() {
    this.$bus.on(socketIoFloors, this.onSocketIoFloorMessage);
  },
  beforeDestroy() {
    this.$bus.off(socketIoFloors, this.onSocketIoFloorMessage);
  },
});
</script>

<style>
.test-bottom {
  //border: 1px solid transparent; //margin: 0 20px 10px 20px !important;
}

.test-top {
  //border: 1px solid transparent; //margin: 0 20px 0 20px !important;
}
</style>
